var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);import{B as s}from"./Base.f46e7956.js";import{a7 as i,D as a,be as n,b2 as o,bf as r,aG as h,t as l,b1 as c,O as d,bg as p,V as u,M as w,_ as m,an as f,q as y,s as g,x as v,n as C,z as b,C as S,b7 as M,aw as x,m as k,aY as E,G as B,ak as P,bh as z,aE as j,aF as V,b4 as L,bi as q,bj as F,b3 as T,bk as _,r as R,K as W,U as A,c as D,e as I,aq as G,u as O,as as N,o as H,p as Q,g as U,a as Y}from"./vendor.d2781f4b.js";import{J}from"./JoyStick.9d2b5199.js";import{K}from"./keyboardMove.b62e2423.js";import{S as X}from"./SoundControl.48b26f99.js";import{M as Z}from"./MiniMap.783e9150.js";import{r as $}from"./common.9712fc3c.js";import{_ as ee}from"./index.40bc08d4.js";class te{constructor(e){this.scene=e}addLights(e){e.shadowMap.enabled=!0,e.shadowMap.type=i;const t=new a(16777215,.25,1);t.position.set(3,10,4),t.target.position.set(0,0,0),t.castShadow=!0,this.sun=t,this.scene.add(t)}set shadowTarget(e){void 0!==this.sun&&(this.sun.target=e)}createCannonTrimesh(e){if(!e.isBufferGeometry)return null;const t=e.attributes.position,s=e.attributes.position.array;let i=[];for(let a=0;a<t.count;a++)i.push(a);return new n(s,i)}createCannonConvex(e){if(!e.isBufferGeometry)return null;const t=e.attributes.position,s=e.attributes.position.array,i=[],a=[];let n=[],h=0;for(let r=0;r<t.count;r+=3)i.push(new o(s[r],s[r+1],s[r+2])),n.push(h++),3===n.length&&(a.push(n),n=[]);return new r(i,a)}addVisual(e,t,s={castShadow:!1,receiveShadow:!0,color:8947848}){const{castShadow:i,receiveShadow:a,color:n}=s;let o;e.name=t,void 0===this.currentMaterial&&(this.currentMaterial=new h({color:n})),void 0===this.settings&&(this.settings={stepFrequency:60,quatNormalizeSkip:2,quatNormalizeFast:!0,gx:0,gy:0,gz:0,iterations:3,tolerance:1e-4,k:1e6,d:3,scene:0,paused:!1,rendermode:"solid",constraints:!1,contacts:!1,cm2contact:!1,normals:!1,axes:!1,particleSize:.1,shadows:!1,aabbs:!1,profiling:!1,maxSubSteps:3},this.particleGeo=new l(1,16,8),this.particleMaterial=new h({color:16711680})),e instanceof c&&(o=this.shape2Mesh(e,i,a,n)),o&&(e.threemesh=o,o.name=t,o.castShadow=i,o.receiveShadow=a,this.scene.add(o))}shape2Mesh(e,t,s,i){const a=new d,n=this.currentMaterial,r=this;let c=0;return e.shapes.forEach((async function(x){let k,E,B,P,z;switch(x.type){case p.types.SPHERE:const t=new l(x.radius,8,8);k=new w(t,n);break;case p.types.CYLINDER:const s=new M(x.radiusTop,x.radiusBottom,x.height,x.numSegments);k=new w(s,new h({color:16777215,wireframe:!1,transparent:!1,opacity:1}));break;case p.types.PARTICLE:k=new w(r.particleGeo,r.particleMaterial);const a=this.settings;k.scale.set(a.particleSize,a.particleSize,a.particleSize);break;case p.types.PLANE:E=new C(200,200,16,16),k=new d;const c=new d,V=await(new b).setPath("images/").load("texture/3_colors.png");V.wrapS=V.wrapT=S,V.repeat.set(20,20);const L=new y({color:"#ffffff",shininess:1,map:V,side:g}),q=new w(E,L);q.position.copy(e.position),q.quaternion.copy(e.quaternion),c.add(q),k.add(c);break;case p.types.BOX:const F=new v(2*x.halfExtents.x,2*x.halfExtents.y,2*x.halfExtents.z);k=new w(F,new h({color:i}));break;case p.types.CONVEXPOLYHEDRON:const T=new(void 0);x.vertices.forEach((function(e){T.vertices.push(new u(e.x,e.y,e.z))})),x.faces.forEach((function(e){const t=e[0];for(let s=1;s<e.length-1;s++){const i=e[s],a=e[s+1];T.faces.push(new(void 0)(t,i,a))}})),T.computeBoundingSphere(),T.computeFaceNormals(),k=new w(T,n);break;case p.types.HEIGHTFIELD:B=new o,P=new o,z=new o;const _=x.data.length*x.data.length*3;let R=[];const W=new Float32Array(_);E=new m;for(let e=0;e<x.data.length-1;e++)for(let t=0;t<x.data[e].length-1;t++){for(let s=0;s<2;s++)x.getConvexTrianglePillar(e,t,0===s),B.copy(x.pillarConvex.vertices[0]),P.copy(x.pillarConvex.vertices[1]),z.copy(x.pillarConvex.vertices[2]),B.vadd(x.pillarOffset,B),P.vadd(x.pillarOffset,P),z.vadd(x.pillarOffset,z);R.push(B.x),R.push(B.y),R.push(B.z),R.push(P.x),R.push(P.y),R.push(P.z),R.push(z.x),R.push(z.y),R.push(z.z)}R.map(((e,t)=>{W[t]=e})),E.setAttribute("position",new f(W,3)),k=new w(E,new y({wireframe:!1,color:"#00ff00",side:g}));break;case p.types.TRIMESH:E=new(void 0),B=new o,P=new o,z=new o;for(let e=0;e<x.indices.length/3;e++){x.getTriangleVertices(e,B,P,z),E.vertices.push(new u(B.x,B.y,B.z),new u(P.x,P.y,P.z),new u(z.x,z.y,z.z));var j=E.vertices.length-3;E.faces.push(new(void 0)(j,j+1,j+2))}E.computeBoundingSphere(),E.computeFaceNormals(),k=new w(E,new h({vertexColors:void 0,wireframe:!1}));break;default:throw new Error("Visual type not recognized: "+x.type)}k.receiveShadow=s,k.castShadow=t,k.traverse((function(e){e.isMesh&&(e.castShadow=t,e.receiveShadow=s)}));var V=e.shapeOffsets[c],L=e.shapeOrientations[c++];k.position.set(V.x,V.y,V.z),k.quaternion.set(L.x,L.y,L.z,L.w),a.add(k)})),a}updateBodies(e){e.bodies.forEach((function(e){void 0!==e.threemesh&&"wheel"!=e.name&&"ground"!=e.name&&(e.threemesh.position.copy(e.position),e.threemesh.quaternion.copy(e.quaternion))}))}}class se extends s{constructor(e){super(e),t(this,"view","third"),t(this,"joyStick",null),t(this,"js",{forward:0,turn:0}),t(this,"isMobile",!1),t(this,"textureLoader",(new b).setPath(this.publicPath.texture)),t(this,"pMesh",null),t(this,"playerPosition",new u),t(this,"playerQuaternion",new x)}init(){this.setupCamera(),this.setupBasis(),this.setupPhysics(),this.addMiniMap()}setupCamera(){this.camera=new k(75,window.innerWidth/window.innerHeight,.1,500),this.camera.position.set(-3,30,20),this.scene.background=(new E).setPath(`${this.publicPath.image}skybox/race.parts/`).load(["px.png","nx.png","py.png","ny.png","pz.png","nz.png"])}addMiniMap(){this.miniMap=new Z({target:this.vehicle.chassisBody.threemesh,scene:this.scene,mapSize:25,mapSyncRotateZ:!1,position:"bottom right"})}createCarParts(e){let t=new B;const s=new w(new P(.4,.6,6),new y({color:15961211}));s.position.set(0,.3,0),t.add(s);const i=new w(new v(1,.6,2),new y({color:7426121}));i.position.set(0,.6,0),e.add(i);let a=e.position.clone();a.y+=.8;const n=new z(new u(0,0,-1),a,2,16770197,.4,.3);n.line.material.linewidth=2,n.line.material.depthTest=!1,n.line.material.transparent=!0,n.cone.material.opacity=1,this.arrow=n,t.add(n),t.position.set(0,1,0),e.add(t)}updateMapPlayer(e){this.playerPosition.copy(e.position),this.playerQuaternion.copy(e.quaternion)}setupBasis(){this.helper=new te(this.scene),this.helper.addLights(this.renderer),"ontouchstart"in document.documentElement?(this.joyStick=new J({game:this,onMove:this.joyStickCallback}),this.isMobile=!0):(this.keyCtrl=new K({game:this,onMove:this.joyStickCallback,onViewChange:this.onViewChangeCallback}),this.isMobile=!1)}setupPhysics(){this.createWorld(-9.8,!1),this.createWorldMaterial(),this.createPlaneGround(),this.loadSounds(),this.createRandomCube()}loadSounds(){this.soundCtrl=new X(this.camera,"sounds/carGame/"),this.soundCtrl.load("collide2","mp3",!1,1,!0),this.soundCtrl.load("engine","mp3",!0,1,!0),this.vehicle.chassisBody.threemesh.add(this.soundCtrl.sounds.engine)}playHitSound(e){e.contact.getImpactVelocityAlongNormal()>.5&&(this.soundCtrl.setVolume("collide2",Math.random()),this.soundCtrl.play("collide2"))}playEngineSound(){this.soundCtrl.play("engine")}stopEngineSound(){this.soundCtrl.stop("engine")}onViewChangeCallback(e){e&&("first"==this.view?this.view="third":this.view="first"),"first"==this.view?(this.slerpDamping=.8,this.followCamera.position.x=0,this.followCamera.position.y=2.4,this.followCamera.position.z=1.5):"third"==this.view&&(this.slerpDamping=.01,this.followCamera.position.y=7,this.followCamera.position.z=16)}createWorldMaterial(){const e=new j("groundMaterial"),t=new j("wheelMaterial"),s=new V(e,t,{friction:.3,restitution:0,contactEquationStiffness:1e3});this.world.addContactMaterial(s);const i=new L(new o(1,.3,2)),a=new c({mass:150});a.addShape(i),a.position.set(0,4,0),a.addEventListener("collide",this.playHitSound.bind(this)),this.helper.addVisual(a,"car"),a.threemesh.children[0].material.map=this.textureLoader.load("fire_ball.jpg"),this.createCarParts(a.threemesh),this.followCamera=new d,this.followCamera.position.copy(this.camera.position),this.onViewChangeCallback(),this.scene.add(this.followCamera),this.followCamera.parent=a.threemesh;const n={radius:.5,directionLocal:new o(0,-1,0),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:5,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new o(-1,0,0),chassisConnectionPointLocal:new o(1,1,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-30,useCustomSlidingRotationalSpeed:!0},r=new q({chassisBody:a,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2});r.addToWorld(this.world),n.chassisConnectionPointLocal.set(1,0,-1),r.addWheel(n),n.chassisConnectionPointLocal.set(-1,0,-1),r.addWheel(n),n.chassisConnectionPointLocal.set(1,0,1),r.addWheel(n),n.chassisConnectionPointLocal.set(-1,0,1),r.addWheel(n);const h=[];r.wheelInfos.forEach((e=>{const s=new F(e.radius,e.radius,e.radius/2,36),i=new c({mass:1,material:t}),a=new _;a.setFromAxisAngle(new o(0,0,1),Math.PI/2),i.addShape(s,new o,a),h.push(i),this.world.addBody(i),this.helper.addVisual(i,"wheel")})),this.vehicle=r,this.world.addEventListener("postStep",(()=>{this.vehicle.wheelInfos.map(((e,t)=>{this.vehicle.updateWheelTransform(t);const s=e.worldTransform;h[t].threemesh.position.copy(s.position),h[t].threemesh.quaternion.copy(s.quaternion)}))}))}createPlaneGround(){const e=new j("ground"),t=new T,s=new c({mass:0,material:e});s.addShape(t),s.quaternion.setFromAxisAngle(new o(1,0,0),-Math.PI/2),s.position.y=-.8,this.world.addBody(s),this.helper.addVisual(s,"ground",!0,!0)}createRandomCube(){for(let e=0;e<40;e++){if(e%2!=0)continue;let t=.5;const s=new L(new o(t,t,t)),i=new c({mass:100});let a=20*Math.sin(e)-1,n=.1,r=20*Math.cos(e)-10;i.position.set(a,n,r),i.addShape(s),this.world.addBody(i),this.helper.addVisual(i,"cube_"+e,{color:$()})}for(let e=0;e<40;e++){if(e%2!=0)continue;let t=.5;const s=new L(new o(t,t,t)),i=new c({mass:1});let a=30*Math.sin(e)-1,n=.1,r=30*Math.cos(e)-10;i.position.set(a,n,r),i.addShape(s),this.world.addBody(i),this.helper.addVisual(i,"cube_"+e,{color:$()})}for(let e=0;e<20;e++){if(e%2!=0)continue;let t=.5;const s=new L(new o(t,t,t)),i=new c({mass:1});let a=-40,n=.02,r=30*Math.cos(e+1)-20;i.position.set(a,n,r),i.addShape(s),this.world.addBody(i),this.helper.addVisual(i,"cube_"+e,{color:$()})}for(let e=0;e<20;e++){if(e%2!=0)continue;let t=.5;const s=new L(new o(t,t,t)),i=new c({mass:1});let a=-50,n=.1,r=30*Math.cos(e+1)-20;i.position.set(a,n,r),i.addShape(s),this.world.addBody(i),this.helper.addVisual(i,"cube_"+e,{color:$()})}}joyStickCallback(e,t){this.js.forward=e,this.js.turn=-t,0!=e?this.playEngineSound():this.stopEngineSound()}updateDrive(e=this.js.forward,t=this.js.turn,s=!1){const i=1e3*e,a=.5*t;0!=e?(this.vehicle.setBrake(0,0),this.vehicle.setBrake(0,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),s?(this.vehicle.applyEngineForce(i,2),this.vehicle.applyEngineForce(i,3)):(this.vehicle.applyEngineForce(i,0),this.vehicle.applyEngineForce(i,1))):s?(this.vehicle.setBrake(15,2),this.vehicle.setBrake(15,3)):(this.vehicle.setBrake(15,0),this.vehicle.setBrake(15,1)),this.vehicle.setSteeringValue(a,0),this.vehicle.setSteeringValue(a,1),this.updateMapPlayer(this.vehicle.chassisBody.threemesh)}updateCamera(){this.camera.position.lerp(this.followCamera.getWorldPosition(new u),this.slerpDamping),this.camera.quaternion.slerp(this.followCamera.getWorldQuaternion(new x),this.slerpDamping),null!=this.helper.sun&&(this.helper.sun.position.copy(this.camera.position),this.helper.sun.position.y+=10)}update(e,t){if(this.vehicle){if(this.helper.updateBodies(this.world),this.updateDrive(),this.updateCamera(),this.keyCtrl&&this.keyCtrl.update(t),this.arrow){let e=this.vehicle.chassisBody.threemesh.getWorldDirection(new u(0,1,0));e.z=-1,this.arrow.setDirection(e)}this.miniMap&&this.miniMap.update()}}hide(){this.miniMap.destory()}}const ie=e=>(Q("data-v-928a8463"),e=e(),U(),e),ae=ie((()=>Y("div",{class:"tips"},"PC：w 前 ｜ s 后 ｜ a 左 ｜ d 右 ｜ c 切换视野",-1))),ne=ie((()=>Y("div",{id:"joystick_ctrl"},null,-1))),oe=ee({__name:"CarGame",setup(e){const t=new se(".container");let s=R(null),i=R(!1);const a=()=>{t.onViewChangeCallback(!0)};return W((()=>{t.onMounted(),i.value=t.isMobile})),A((()=>{t.onUnmounted()})),(e,t)=>(H(),D("div",{class:"container",ref_key:"container",ref:s},[ae,ne,I(" "+G(O(i))+" ",1),O(i)?(H(),D("div",{key:0,class:"toggleview",onClick:a},"C")):N("",!0)],512))}},[["__scopeId","data-v-928a8463"]]);export{oe as default};
