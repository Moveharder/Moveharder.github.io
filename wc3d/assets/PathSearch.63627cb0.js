var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);import{aZ as i,_ as s,L as n,a_ as o,M as h,a$ as r,v as a,V as l,G as c,n as u,s as p,bv as d,q as g,x as m,bw as f,a4 as v,a3 as y,bx as w,a1 as b,r as x,K as k,U as C,c as M,a as P,bt as j,by as S,u as F,F as T,ao as L,e as z,bz as D,aq as R,o as _,p as G,g as N}from"./vendor.d2781f4b.js";import{B as O}from"./Base.f46e7956.js";import{M as W}from"./MiniMap.783e9150.js";import{C as A}from"./ClickAnchorRender.8273250c.js";import{_ as B}from"./index.3fe0440b.js";function H(t){for(var e=t,i=[];e.parent;)i.unshift(e),e=e.parent;return i}var U={search:function(t,e,i,s){t.cleanDirty();var n=(s=s||{}).heuristic||U.heuristics.manhattan,o=s.closest||!1,h=new $((function(t){return t.f})),r=e;for(e.h=n(e,i),t.markDirty(e),h.push(e);h.size()>0;){var a=h.pop();if(a===i)return H(a);a.closed=!0;for(var l=t.neighbors(a),c=0,u=l.length;c<u;++c){var p=l[c];if(!p.closed&&!p.isWall()){var d=a.g+p.getCost(a),g=p.visited;(!g||d<p.g)&&(p.visited=!0,p.parent=a,p.h=p.h||n(p,i),p.g=d,p.f=p.g+p.h,t.markDirty(p),o&&(p.h<r.h||p.h===r.h&&p.g<r.g)&&(r=p),g?h.rescoreElement(p):h.push(p))}}}return o?H(r):[]},heuristics:{manhattan:function(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)},diagonal:function(t,e){var i=Math.sqrt(2),s=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return 1*(s+n)+(i-2)*Math.min(s,n)}},cleanNode:function(t){t.f=0,t.g=0,t.h=0,t.visited=!1,t.closed=!1,t.parent=null}};function E(t,e){e=e||{},this.nodes=[],this.diagonal=!!e.diagonal,this.grid=[];for(var i=0;i<t.length;i++){this.grid[i]=[];for(var s=0,n=t[i];s<n.length;s++){var o=new V(i,s,n[s]);this.grid[i][s]=o,this.nodes.push(o)}}this.init()}function V(t,e,i){this.x=t,this.y=e,this.weight=i}function $(t){this.content=[],this.scoreFunction=t}E.prototype.init=function(){this.dirtyNodes=[];for(var t=0;t<this.nodes.length;t++)U.cleanNode(this.nodes[t])},E.prototype.cleanDirty=function(){for(var t=0;t<this.dirtyNodes.length;t++)U.cleanNode(this.dirtyNodes[t]);this.dirtyNodes=[]},E.prototype.markDirty=function(t){this.dirtyNodes.push(t)},E.prototype.neighbors=function(t){var e=[],i=t.x,s=t.y,n=this.grid;return n[i-1]&&n[i-1][s]&&e.push(n[i-1][s]),n[i+1]&&n[i+1][s]&&e.push(n[i+1][s]),n[i]&&n[i][s-1]&&e.push(n[i][s-1]),n[i]&&n[i][s+1]&&e.push(n[i][s+1]),this.diagonal&&(n[i-1]&&n[i-1][s-1]&&e.push(n[i-1][s-1]),n[i+1]&&n[i+1][s-1]&&e.push(n[i+1][s-1]),n[i-1]&&n[i-1][s+1]&&e.push(n[i-1][s+1]),n[i+1]&&n[i+1][s+1]&&e.push(n[i+1][s+1])),e},E.prototype.toString=function(){for(var t=[],e=this.grid,i=0;i<e.length;i++){for(var s=[],n=e[i],o=0;o<n.length;o++)s.push(n[o].weight);t.push(s.join(" "))}return t.join("\n")},V.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},V.prototype.getCost=function(t){return t&&t.x!=this.x&&t.y!=this.y?1.41421*this.weight:this.weight},V.prototype.isWall=function(){return 0===this.weight},$.prototype={push:function(t){this.content.push(t),this.sinkDown(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bubbleUp(0)),t},remove:function(t){var e=this.content.indexOf(t),i=this.content.pop();e!==this.content.length-1&&(this.content[e]=i,this.scoreFunction(i)<this.scoreFunction(t)?this.sinkDown(e):this.bubbleUp(e))},size:function(){return this.content.length},rescoreElement:function(t){this.sinkDown(this.content.indexOf(t))},sinkDown:function(t){for(var e=this.content[t];t>0;){var i=(t+1>>1)-1,s=this.content[i];if(!(this.scoreFunction(e)<this.scoreFunction(s)))break;this.content[i]=e,this.content[t]=s,t=i}},bubbleUp:function(t){for(var e=this.content.length,i=this.content[t],s=this.scoreFunction(i);;){var n,o=t+1<<1,h=o-1,r=null;if(h<e){var a=this.content[h];(n=this.scoreFunction(a))<s&&(r=h)}if(o<e){var l=this.content[o];this.scoreFunction(l)<(null===r?s:n)&&(r=o)}if(null===r)break;this.content[t]=this.content[r],this.content[r]=i,t=r}}};class q{constructor(t){e(this,"_scene",null),e(this,"routes",[]),this._scene=t}createPath(t={name:"",path:[],divisions:60,isClosed:!0,showPathLine:!0,pathLineColor:65280,attachObject:null,meshColor:16711680,once:!1,moveSpeed:.01,lerpSpeed:.001}){const{path:e,name:c,divisions:u,isClosed:p,showPathLine:d,pathLineColor:g,attachObject:m,meshColor:f,once:v,moveSpeed:y=.01,lerpSpeed:w=.01,onFinish:b=null}=t;let x=new i(e,p),k=null;if(d){const t=x.getPoints(u),e=(new s).setFromPoints(t),i=new n({color:g});k=new o(e,i),this._scene.add(k)}let C=null;C=m&&m.isMesh?m:new h(new r(.3,.3,.5),new a({color:f})),this._scene.add(C),this.routes.push({name:c||"curve_path",curve:x,curveLength:x.getLength(),curveMesh:k,pathLength:e.length,moveMesh:C,moveMeshPosition:new l,moveMeshTarget:new l,once:v,moveSpeed:y,lerpSpeed:w,distance:0,onFinish:b,attachObject:m})}update(t){this.routes.map(((t,e)=>{let{curve:i,curveLength:s,curveMesh:n,pathLength:o,moveMesh:h,moveMeshPosition:r,moveMeshTarget:a,once:l,moveSpeed:c,lerpSpeed:u,distance:p,onFinish:d,attachObject:g}=t;p+=c;let m=p/s;if(l&&m>=1)return this._scene.remove(n),g||this._scene.remove(h),this.routes.splice(e,1),p=s,void(d&&d(p.toFixed(2),o));t.distance=p;const f=u;i.getPointAt(m%1,r),i.getPointAt((m+f)%1,a),h.position.copy(r),h.lookAt(a)}))}}let Y=null,I=null;class X extends O{constructor(t){super(t),e(this,"row",20),e(this,"col",20),e(this,"weightRange",[0,9]),e(this,"weight",2),e(this,"blocks",[]),e(this,"pixels",[]),e(this,"grids",[]),e(this,"fromTo",[{i:0,j:0},{i:1,j:1}]),e(this,"result",[]),e(this,"tmpClickPosVec3",new l),e(this,"resultEl",null),e(this,"spendTime",0),e(this,"openSmoothPath",!0)}init(){this.camera.position.set(0,10,10),this.resultEl=document.querySelector(".result"),Y=new A(this.scene,{color:"#ffffff",opacity:1}),I=new q(this.scene),this.createPlayer(),this.createMiniMap(),this.createOrbitControls(),this.setupControls(),this.addListeners(),this.createGridMap(),this.createRoadBlock()}setupControls(){this.controls.enableDamping=!0,this.controls.enablePan=!1,this.controls.maxPolarAngle=1.5,this.controls.minPolarAngle=1.5*.3}addListeners(){document.addEventListener("click",this.clickGrid.bind(this),!1)}createPlayer(){this.player=this.createCube(.5,[0,.35,0],65280),this.scene.add(this.player),this.player.position.setY(0,.3,0)}createMiniMap(){this.miniMap=new W({target:this.player,scene:this.scene,mapSize:12,mapRenderSize:160})}createGridMap(t=this.row,e=this.col,i=.5,s=.5,n=.1){this.pixels.length&&(this.scene.remove(this.gridGroup),this.pixels=[]);let o=e*(i+n)-n,r=t*(s+n)-n;this.row=t,this.col=e,this.gridWidth=i,this.gridHeight=s,this.W=o,this.H=r,this.gridGroup=new c;let l=new u(i,s);for(let c=0;c<t;c++){let t=[];for(let u=0;u<e;u++){let e=new h(l,new a({color:56831,side:p,transparent:!0,opacity:.1})),d=u*i-o/2+n*u+i/2,g=0,m=c*s-r/2+n*c+s/2;e.position.set(d,g,m),e.rotation.x=-Math.PI/2,e.userData={x:d,y:g,z:m,i:c,j:u},t.push(e),this.gridGroup.add(e)}this.pixels.push(t)}this.scene.add(this.gridGroup)}createRoadBlock(){this.blocks.length&&(this.grids=[],this.scene.remove(...this.blocks),this.blocks=[]);const{row:t,col:e,weight:i,weightRange:s}=this;let n=[],o=!1;for(let h=0;h<t;h++){n[h]=[];for(let r=0;r<e;r++){if(d(s[0],s[1])<i)n[h].push(0),this.addRoadBlock(h,r);else if(n[h].push(1),!o){let i=this.pixels[d(0,t-1)][d(0,e-1)],s=i.position,n=i.userData;this.updatePlayerPosition(s),this.updateFromTo(0,n),o=!0}}}this.grids=n}addRoadBlock(t,e){let i=this.pixels[t][e].position,s=this.createCube(this.gridWidth,[i.x,this.gridHeight/2+.1,i.z]);this.blocks.push(s),this.scene.add(s)}createCube(t,e=[],i=16768256,s=f){let n=new g({color:i,side:s}),o=new m(t,t,t),r=new h(o,n);return r.position.set(...e),r}clickGrid(t){const{W:e,H:i,camera:s,tmpClickPosVec3:n}=this;let o=new v;o.x=t.clientX/window.innerWidth*2-1,o.y=-t.clientY/window.innerHeight*2+1;const h=new y;h.setFromCamera(o,s);let r=h.intersectObjects(this.pixels.flat(),!0);if(r.length){const{object:t,point:e}=r[0];let i=t.userData;this.updateFromTo(1,i),n.x=i.x,n.y=i.y,n.z=i.z,Y.create(n),this.search()}}pickupObjects(t){const{W:e,H:i,camera:s}=this;let n=new v;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;const o=new w(new l(0,1,0),0),h=new y;h.setFromCamera(n,s);const r=new l;h.ray.intersectPlane(o,r);const a=r.x,c=r.z;if(Math.abs(a)>e/2||Math.abs(c)>i/2)return;let u,p;for(let l=-e/2;l<i/2;l+=10)a>=l&&a<l+10&&(u=l+5);for(let l=-e/2;l<i/2;l+=10)c>=l&&c<l+10&&(p=l+5)}search(){this.updateResultContent("pending","-","-");let[t,e]=this.fromTo,i=new E(this.grids),s=i.grid[t.i][t.j],n=i.grid[e.i][e.j],o=+new Date,h=U.search(i,s,n),r=+new Date;if(this.spendTime=r-o,!h.length)return this.updateResultContent("Unreachable",this.spendTime,"-"),void b.to(this.gridGroup.position,{y:-.5,duration:.1,onComplete:()=>{b.to(this.gridGroup.position,{y:0,duration:.1})}});let a=[];this.result=h;let l=h.length>6?3:h.length>4?2:1;h.map(((t,e)=>{const{x:i,y:s}=t;let n=this.pixels[i][s];e%l!=0&&e!=h.length-1||a.push(n.position),b.to(n.material,{opacity:1,duration:e/10+.1,onComplete:()=>{b.to(n.material,{opacity:.1,duration:3})}})})),this.openSmoothPath?this.runSmoothPath(a):this.animateToNext(0)}animateToNext(t){let e=this.result.length;if(t>=e){this.updateResultContent("Arrived",this.spendTime,t+1);let i=this.result[e-1];return this.updateFromTo(0,{i:i.x,j:i.y}),void Y.destroy()}const{x:i,y:s}=this.result[t];let n=this.pixels[i][s];b.to(this.player.position,{x:n.position.x,y:n.position.y+.3,z:n.position.z,duration:.06,onComplete:()=>{this.animateToNext(++t)}})}runSmoothPath(t){I.createPath({name:"起始路线",path:t,divisions:t.length,isClosed:!1,showPathLine:!0,pathLineColor:65280,attachObject:this.player,meshColor:16711680,once:!0,moveSpeed:.1,onFinish:(t,e)=>{this.updateResultContent("Arrived",this.spendTime>0?this.spendTime:"<1",e,t);let i=this.result[this.result.length-1];this.updateFromTo(0,{i:i.x,j:i.y}),Y.destroy()}})}updateFromTo(t,e){this.fromTo[t]={...e}}updatePlayerPosition(t){this.player.position.copy(t),this.player.position.setY(.3)}updateResultContent(t,e,i,s){this.resultEl.innerHTML=`结果：${t}<br/>耗时：${e}ms<br/>移动：${i}步 ${s?s+"米":""}`}updateSize(t){this.row=t,this.col=t,this.createGridMap(),this.createRoadBlock()}updateWeight(t){this.weight=t}update(t,e){this.miniMap.update(),I.update(e)}hide(){this.miniMap.destory()}}const K=(t=>(G("data-v-90f1eb20"),t=t(),N(),t))((()=>P("div",{class:"result"},null,-1))),Z=["value"],J=["value"],Q=B({__name:"PathSearch",setup(t){const e=new X(".container");let i=x(null),s=x(e.row),n=x(e.weight),o=x(e.openSmoothPath);window.game=e;const h=()=>{e.updateWeight(n.value)},r=()=>{e.updateSize(s.value)},a=()=>{e.createRoadBlock()},l=()=>{o.value=!o.value,e.openSmoothPath=o.value};return k((()=>{e.onMounted()})),C((()=>{e.onUnmounted()})),(t,e)=>(_(),M(T,null,[P("div",{class:"container",ref_key:"container",ref:i},null,512),K,j(P("select",{class:"btn gridsize",onChange:r,"onUpdate:modelValue":e[0]||(e[0]=t=>D(s)?s.value=t:s=t)},[(_(),M(T,null,L([10,20,30,40,50,60],((t,e)=>P("option",{key:e,value:t},R(t)+"x"+R(t)+" 规格 ",9,Z))),64)),z("> ")],544),[[S,F(s)]]),j(P("select",{class:"btn blockweight",onChange:h,"onUpdate:modelValue":e[1]||(e[1]=t=>D(n)?n.value=t:n=t)},[(_(),M(T,null,L([0,1,2,3,4,5,6,7,8,9,10],((t,e)=>P("option",{key:e,value:t},R(10*t)+"% 障碍物 ",9,J))),64)),z("> ")],544),[[S,F(n)]]),P("button",{class:"btn blocks",onClick:a},"生成障碍物"),P("button",{class:"btn finder",onClick:l},R(F(o)?"格子路径":"平滑路径"),1)],64))}},[["__scopeId","data-v-90f1eb20"]]);export{Q as default};
